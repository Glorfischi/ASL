---
- name: Add ssh key for root
  user:
    name: root
    generate_ssh_key: yes
    ssh_key_bits: 2048
    ssh_key_file: .ssh/id_rsa
  register: backup_user_info
  become: true

- name: Add user for backups on backup server
  user:
    name: "{{ inventory_hostname }}-backup"
  become: true
  delegate_to: backup

- name: Set authorized key for backup user
  authorized_key:
    user: "{{ inventory_hostname }}-backup"
    state: present
    key: "{{ backup_user_info.ssh_public_key }}"
  become: true
  delegate_to: backup

- name: Synchronization using rsync protocol (push)
  command: "/usr/bin/rsync -e \"ssh -o StrictHostKeyChecking=no\"--delay-updates -F --compress -avzhe ssh /home/hydra-backup/src hydra-backup@backup.fadalax.tech:/home/hydra-backup/dst"
  become: yes
